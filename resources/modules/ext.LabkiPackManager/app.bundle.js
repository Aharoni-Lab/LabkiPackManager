var Vue="undefined"!=typeof mw&&mw.loader&&mw.loader.require?mw.loader.require("vue"):window.Vue,Codex="undefined"!=typeof mw&&mw.loader&&mw.loader.require?mw.loader.require("@wikimedia/codex")||mw.loader.require("codex"):window.Codex,mermaid=function(){try{if("undefined"!=typeof window&&window.mermaid)return window.mermaid;if("undefined"!=typeof mw&&mw.loader&&mw.loader.require){var e=mw.loader.require("ext.mermaid");if(e?.initialize)return e;if(e?.mermaid?.initialize)return e.mermaid;if(e?.default?.initialize)return e.default}}catch(e){}return window.mermaid}(),LabkiPackManager=function(e,t,a,s){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(a){if("default"!==a){var s=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,s.get?s:{enumerable:!0,get:function(){return e[a]}})}}),t.default=e,Object.freeze(t)}var o=n(t),i=n(a);async function r(e,t=!1){const a=mw.util.wikiScript("api"),s=new URLSearchParams({action:"labkiManifest",format:"json",formatversion:"2",repo:e});t&&s.set("refresh","1");const n=`${a}?${s.toString()}`;let o,i;try{o=await fetch(n,{credentials:"same-origin"})}catch(t){throw new Error(`Network error fetching manifest for ${e}: ${t}`)}if(!o.ok)throw new Error(`HTTP ${o.status} fetching manifest for ${e}`);try{i=await o.json()}catch(t){throw new Error(`Invalid JSON from ${e}: ${t}`)}return i.labkiManifest||i}async function l(){const e=function(){if("undefined"==typeof mw||!mw.config)return[];const e=mw.config.get("LabkiContentSources")||mw.config.get("wgLabkiContentSources");return Array.isArray(e)?e:[]}();if(0===e.length)return console.warn("[LabkiPackManager] No LabkiContentSources defined."),[];const t=await Promise.allSettled(e.map(e=>r(e,!1))),a=[];return t.forEach((t,s)=>{const n=e[s];if("fulfilled"===t.status&&t.value){const e=t.value,s=e?._meta?.repoName||e?.manifest?.name||n.split("/").slice(-2).join("/");a.push({url:n,name:s,data:e})}else console.warn(`[LabkiPackManager] Repo ${n} failed:`,t.reason instanceof Error?t.reason.message:t.reason)}),a}function c(e){if(!e||"string"!=typeof e)return 0;const t=parseInt(e.split(".")[0]||"0",10);return Number.isFinite(t)?t:0}function p(e,t){const a=String(e||"").split(".").map(e=>parseInt(e,10)).map(e=>Number.isFinite(e)?e:0),s=String(t||"").split(".").map(e=>parseInt(e,10)).map(e=>Number.isFinite(e)?e:0);for(let e=0;e<3;e++){const t=a[e]??0,n=s[e]??0;if(t>n)return 1;if(t<n)return-1}return 0}const d=Object.freeze({SUCCESS:"success",ERROR:"error",INFO:"info",WARNING:"warning"});function m(e,t){if(t&&"string"==typeof t.name&&t.name)return t.name;const a=String(e).indexOf(":");return a>0?String(e).slice(a+1):String(e)}function u(e,t){return t&&"string"==typeof t.type?"pack"===t.type:String(e).startsWith("pack:")}var h={name:"LpmToolbar",props:{repoMenuItems:{type:Array,required:!0,validator:e=>Array.isArray(e)&&e.every(e=>e.label&&e.value)},activeRepo:{type:String,default:null},isLoadingRepo:{type:Boolean,default:!1},isRefreshing:{type:Boolean,default:!1},hasActiveRepo:{type:Boolean,required:!0}},emits:["update:activeRepo","load","refresh"]};const f={class:"lpm-row lpm-row-toolbar",role:"toolbar","aria-label":"Repository controls"},g={key:0,"aria-busy":"true","aria-live":"polite"},k={key:0,"aria-busy":"true","aria-live":"polite"};h.render=function(e,a,s,n,o,i){const r=t.resolveComponent("cdx-select"),l=t.resolveComponent("cdx-button");return t.openBlock(),t.createElementBlock("div",f,[t.createCommentVNode(" Repository selector "),t.createVNode(r,{id:"lpm-repo-select","aria-label":"Repository selector",class:"lpm-toolbar-select","menu-items":s.repoMenuItems,selected:s.activeRepo,disabled:s.isLoadingRepo,placeholder:"Select a content repository…","onUpdate:selected":a[0]||(a[0]=t=>e.$emit("update:activeRepo",t))},null,8,["menu-items","selected","disabled"]),t.createCommentVNode(" Load button "),t.createVNode(l,{appearance:"primary",disabled:s.isLoadingRepo||!s.hasActiveRepo,class:"lpm-toolbar-btn",onClick:a[1]||(a[1]=t=>e.$emit("load"))},{default:t.withCtx(()=>[s.isLoadingRepo?(t.openBlock(),t.createElementBlock("span",g,"Loading…")):(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createTextVNode("Load")],64))]),_:1},8,["disabled"]),t.createCommentVNode(" Refresh button "),t.createVNode(l,{appearance:"quiet",disabled:s.isRefreshing||!s.hasActiveRepo,class:"lpm-toolbar-btn",onClick:a[2]||(a[2]=t=>e.$emit("refresh"))},{default:t.withCtx(()=>[s.isRefreshing?(t.openBlock(),t.createElementBlock("span",k,"Refreshing…")):(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createTextVNode("Refresh")],64))]),_:1},8,["disabled"])])},h.__scopeId="data-v-56b90443",h.__file="resources/src/ui/toolbar.vue";var y={name:"LpmTree",components:{LpmPackNode:{name:"lpm-pack-node",inject:["lpmCtx"],props:{node:{type:Object,required:!0},depth:{type:Number,default:0}},computed:{packName(){if("string"==typeof this.node.name&&this.node.name)return this.node.name;const e=this.node.id.indexOf(":");return e>0?this.node.id.slice(e+1):this.node.id},packId(){return this.node.id.startsWith("pack:")?this.node.id:`pack:${this.packName}`},packLabelId(){return`pack-label-${this.lpmCtx.sanitizeId(this.packName)}`},isOpen(){return!!this.lpmCtx.expanded[this.packId]},isSelected(){return!!this.lpmCtx.selectedPacks[this.packName]},pages(){return this.resolvePages()},childPacks(){return this.resolveChildPacks()},flatPack(){return this.lpmCtx.nodes[this.packId]||this.node}},created(){this.packId in this.lpmCtx.expanded||(this.lpmCtx.expanded[this.packId]=!0)},methods:{getNode(e){const t=e.startsWith("pack:")?e:`pack:${e}`;return this.lpmCtx.nodes[t]},resolvePages(){const e=this.getNode(this.packName);return e?(e.pages||[]).map(e=>"string"==typeof e?{name:e}:{name:e.name,finalTitle:e.finalTitle||null}):[]},resolveChildPacks(){const e=this.getNode(this.packName),t=(Array.isArray(e?.depends_on)?e.depends_on:[]).map(e=>this.getNode(e)).filter(Boolean);return t.length?t:(this.node.children||[]).filter(e=>"pack"===e.type).map(e=>this.getNode(e.id)||e)},toggle(){this.lpmCtx.expanded[this.packId]=!this.isOpen},computeTitleNow(e,t,a){const s=e.indexOf(":"),n=s>0?e.slice(0,s):"",o=s>0?e.slice(s+1):e;return`${n?n+":":""}${t||""}${(a||"").trim()||o}`},updateSel(e){this.lpmCtx.togglePackExplicit(this.packName,e)},updatePrefix(e){const t={...this.lpmCtx.prefixes,[this.packName]:e};if(this.lpmCtx.updatePrefixes(t),!this.flatPack?.isLocked)for(const t of this.pages){const a=`${this.packName}::${t.name}`,s=this.lpmCtx.renames[a]||"",n=this.computeTitleNow(t.name,e,s);this.lpmCtx.debounceCheck(a,n,0)}},updateRename(e,t){const a=`${this.packName}::${e}`,s={...this.lpmCtx.renames,[a]:t};if(this.lpmCtx.updateRenames(s),this.flatPack?.isLocked)return;const n=this.lpmCtx.prefixes[this.packName]||"",o=this.computeTitleNow(e,n,t);this.lpmCtx.debounceCheck(a,o,0)},final(e,t){return this.lpmCtx.computeTitle(e,t)},displayFinal(e){return this.flatPack?.isLocked&&e.finalTitle?e.finalTitle:this.final(this.packName,e.name)},collide(e){return!!this.lpmCtx.collisions[`${this.packName}::${e}`]}},template:'\n        <tbody>\n          \x3c!-- PACK ROW --\x3e\n          <tr class="pack-row">\n            <td class="lpm-indent" :style="{ paddingLeft: (depth * 1.75) + \'em\' }">\n              <button class="lpm-caret" @click="toggle">{{ isOpen ? \'▼\' : \'▶\' }}</button>\n              <strong :id="packLabelId">{{ packName }}</strong>\n            </td>\n            <td>\n              <cdx-checkbox\n                :model-value="isSelected"\n                :disabled="lpmCtx.isPackDisabled(packName) || !!(flatPack && flatPack.isLocked)"\n                :aria-labelledby="packLabelId"\n                @update:model-value="updateSel" />\n            </td>\n            <td>\n              <cdx-text-input\n                :model-value="lpmCtx.prefixes[packName]"\n                placeholder="prefix"\n                :disabled="!isSelected || !!(flatPack && flatPack.isLocked)"\n                @update:model-value="updatePrefix" />\n            </td>\n            <td></td>\n\n            <td class="status-cell">\n              <span v-if="flatPack?.installStatus === \'already-installed\'" class="status-imported">\n                Already imported (v{{ flatPack?.installedVersion || \'—\' }})\n              </span>\n              <span v-else-if="flatPack?.installStatus === \'safe-upgrade\'" class="status-update">\n                Upgrade: {{ flatPack?.installedVersion || \'—\' }} → {{ flatPack?.version || \'—\' }}\n              </span>\n              <span v-else-if="flatPack?.installStatus === \'incompatible-update\' || flatPack?.installStatus === \'downgrade\'" class="status-major">\n                Major version change: {{ flatPack?.installedVersion || \'—\' }} → {{ flatPack?.version || \'—\' }}\n              </span>\n              <span v-else class="status-new">New</span>\n            </td>\n          </tr>\n\n          \x3c!-- PAGE ROWS --\x3e\n          <tr\n            v-for="page in pages"\n            :key="packName + \'::\' + page.name"\n            v-show="isOpen"\n            :class="[\'page-row\', { \'lpm-row-ok\': isSelected && !collide(page.name),\n                                   \'lpm-row-warn\': isSelected && collide(page.name) }]">\n            <td class="lpm-indent lpm-cell-pad-left"\n                :style="{ paddingLeft: ((depth + 1) * 1.75) + \'em\' }">{{ page.name }}</td>\n            <td></td>\n            <td>\n              <cdx-text-input\n                :model-value="lpmCtx.renames[packName + \'::\' + page.name]"\n                placeholder="rename"\n                :disabled="!isSelected || !!(flatPack && flatPack.isLocked)"\n                @update:model-value="v => updateRename(page.name, v)" />\n            </td>\n            <td>\n              \x3c!-- For installed packs, show stored finalTitle --\x3e\n              <template v-if="flatPack?.isLocked && page.finalTitle">\n                {{ page.finalTitle }}\n              </template>\n              <template v-else>\n                {{ final(packName, page.name) }}\n              </template>\n            </td>\n\n            <td class="lpm-status-cell">\n              <span v-if="isSelected && !collide(page.name)" class="lpm-status-included">✓</span>\n              <span v-else-if="isSelected && collide(page.name)" class="lpm-status-warning">⚠</span>\n            </td>\n          </tr>\n        </tbody>\n\n        \x3c!-- RECURSION --\x3e\n        <lpm-pack-node\n          v-for="child in childPacks"\n          v-if="isOpen"\n          :key="child.id"\n          :node="child"\n          :depth="depth + 1" />\n      '}},provide(){const e=this;return{lpmCtx:{get nodes(){return e.nodes},get tree(){return e.tree},get expanded(){return e.expanded},get selectedPacks(){return e.selectedPacks},get prefixes(){return e.prefixes},get renames(){return e.renames},get collisions(){return e.collisions},get treeIndex(){return e.treeIndex},get dependencyMap(){return e.dependencyMap},updateSelectedPacks:t=>e.$emit("update:selectedPacks",t),updatePrefixes:t=>e.$emit("update:prefixes",t),updateRenames:t=>e.$emit("update:renames",t),computeTitle:(t,a)=>e.finalPageTitle(t,a),debounceCheck:(t,a,s)=>e.debounceCheck(t,a,s),scheduleRecheck:()=>e.scheduleCollisionRecheckForVisible(),sanitizeId:e=>String(e).replace(/[^A-Za-z0-9_-]/g,"-"),isPackDisabled:t=>e.isPackDisabled(t),togglePackExplicit:(t,a)=>e.togglePackExplicit(t,a)}}},props:{data:{type:Object,default:null},selectedPacks:{type:Object,required:!0},prefixes:{type:Object,required:!0},renames:{type:Object,required:!0},checkTitleExists:{type:Function,default:null}},emits:["update:selectedPacks","update:prefixes","update:renames"],data:()=>({expanded:Object.create(null),collisions:Object.create(null),debouncers:Object.create(null),collisionVersion:Object.create(null),collisionCache:Object.create(null),pendingCommit:!1,explicitSelectedPacks:Object.create(null),disabledPacks:Object.create(null)}),computed:{nodes(){return this.data?.hierarchy?.nodes||{}},tree(){return(this.data?.hierarchy?.tree||[]).map(e=>"string"==typeof e?this.nodes[e]:e).filter(Boolean)},treeIndex(){const e=Object.create(null);for(const t of Object.keys(this.nodes))t.startsWith("pack:")&&(e[t]||=[]);for(const[t,a]of Object.entries(this.nodes)){if(!t.startsWith("pack:"))continue;const s=a.parent;if(!s)continue;const n=s.startsWith("pack:")?s:`pack:${s}`;e[n]||=[],e[n].push(t)}return e},dependencyMap(){const e=Object.create(null);for(const[t,a]of Object.entries(this.nodes)){if(!t.startsWith("pack:"))continue;const s=m(t,a),n=new Set,o=[...a.depends_on||[]];for(;o.length;){const e=m(o.shift());if(n.has(e))continue;n.add(e);const t=this.nodes[`pack:${e}`];t?.depends_on&&o.push(...t.depends_on)}e[s]=[...n]}return e}},created(){for(const[e,t]of Object.entries(this.selectedPacks||{}))t&&(this.explicitSelectedPacks[e]=!0);this.recomputeSelectedFromExplicit()},methods:{pageKey:(e,t)=>`${e}::${t}`,splitNs(e){if(!e||"string"!=typeof e)return{ns:"",base:""};const t=e.indexOf(":");return t>0?{ns:e.slice(0,t),base:e.slice(t+1)}:{ns:"",base:e}},finalPageTitle(e,t){if(!t||"string"!=typeof t)return"";const{ns:a,base:s}=this.splitNs(t);return`${a?a+":":""}${this.prefixes[e]||""}${(this.renames[this.pageKey(e,t)]||"").trim()||s}`},scheduleCollisionRecheckForVisible(){if(this.checkTitleExists)for(const[e,t]of Object.entries(this.selectedPacks)){if(!t)continue;const a=this.nodes[`pack:${e}`];if(!a?.isLocked)for(const t of a?.pages||[]){const a="string"==typeof t?t:t.name;this.debounceCheck(this.pageKey(e,a),this.finalPageTitle(e,a))}}},computeClosureFrom(e){const t=new Set,a=Object.keys(e).filter(t=>e[t]);for(const e of a)t.add(e);for(;a.length;){const e=a.shift(),s=this.treeIndex[`pack:${e}`]||[];for(const e of s){const s=m(e,this.nodes[e]);t.has(s)||(t.add(s),a.push(s))}const n=this.dependencyMap[e]||[];for(const e of n)t.has(e)||(t.add(e),a.push(e))}return t},recomputeSelectedFromExplicit(){const e=this.computeClosureFrom(this.explicitSelectedPacks),t={},a={};for(const s of e)t[s]=!0,this.explicitSelectedPacks[s]||(a[s]=!0);for(const[e,a]of Object.entries(this.nodes))u(e,a)&&a?.isLocked&&(t[m(e,a)]=!0);this.disabledPacks=a,this.$emit("update:selectedPacks",t),this.scheduleCollisionRecheckForVisible()},isPackDisabled(e){return!!this.disabledPacks[e]},togglePackExplicit(e,t){t?this.explicitSelectedPacks[e]=!0:delete this.explicitSelectedPacks[e],this.recomputeSelectedFromExplicit()},asyncCheck(e){return this.checkTitleExists?e in this.collisionCache?Promise.resolve(this.collisionCache[e]):this.checkTitleExists(e).then(t=>this.collisionCache[e]=!!t):Promise.resolve(!1)},debounceCheck(e,t,a=300){if(!this.checkTitleExists)return;clearTimeout(this.debouncers[e]);const s=(this.collisionVersion[e]||0)+1;this.collisionVersion[e]=s;this.debouncers[e]=setTimeout(async()=>{const a=await this.asyncCheck(t);this.collisionVersion[e]===s&&(this.collisions[e]=!!a,this.pendingCommit||(this.pendingCommit=!0,Promise.resolve().then(()=>{this.collisions={...this.collisions},this.pendingCommit=!1})))},a)},exportSelectionSummary(e){const t=[];for(const[e,a]of Object.entries(this.nodes)){if(!u(e,a))continue;const s=m(e,a),n={name:s,id:e,selected:!!this.selectedPacks[s],version:a.version||null,installedVersion:a.installedVersion||null,installStatus:a.installStatus||"new",isLocked:!!a.isLocked,pages:[]};for(const e of a.pages||[]){const t="string"==typeof e?e:e.name,a="string"!=typeof e&&e.finalTitle?e.finalTitle:this.finalPageTitle(s,t);n.pages.push({original:t,finalTitle:a,prefix:this.prefixes[s]||"",rename:this.renames[this.pageKey(s,t)]||"",collide:!!this.collisions[this.pageKey(s,t)]})}t.push(n)}return{repoUrl:e,packs:t}}}};const w={class:"lpm-row lpm-row-tree"},x={class:"lpm-tree",role:"region","aria-label":"Pack and page selection tree"},v={class:"lpm-tree-table",role:"treegrid"};y.render=function(e,a,s,n,o,i){const r=t.resolveComponent("lpm-pack-node");return t.openBlock(),t.createElementBlock("div",w,[t.createElementVNode("div",x,[t.createElementVNode("table",v,[a[1]||(a[1]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",null,"Name"),t.createElementVNode("th",null,"Select"),t.createElementVNode("th",null,"Prefix / Rename"),t.createElementVNode("th",null,"Final Name"),t.createElementVNode("th",null,"Status")])],-1)),t.createCommentVNode(" Render hierarchy roots "),i.tree.length?(t.openBlock(!0),t.createElementBlock(t.Fragment,{key:0},t.renderList(i.tree,e=>(t.openBlock(),t.createBlock(r,{key:e.id,node:e,depth:0},null,8,["node"]))),128)):(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createCommentVNode(" Empty state "),a[0]||(a[0]=t.createElementVNode("tbody",null,[t.createElementVNode("tr",null,[t.createElementVNode("td",{colspan:"5"},[t.createElementVNode("em",null,"No data loaded.")])])],-1))],2112))])])])},y.__scopeId="data-v-4b584986",y.__file="resources/src/ui/tree.vue";var b={name:"LpmMessages",props:{messages:{type:Array,required:!0,default:()=>[]}},emits:["dismiss"],computed:{normalizedMessages(){const e="undefined"!=typeof window&&window.Codex&&window.Codex.icons&&"cdx-icon-info"in window.Codex.icons,t=["success","warning","error","notice","info"];return this.messages.map(a=>{const s=t.includes(a.type)?a.type:"notice",n="info"!==s||e?s:"notice";return{id:a.id??Math.floor(1e6*Math.random()),text:a.text??"",type:n}})}}};const C={key:0,class:"lpm-row lpm-row-messages"},S={class:"lpm-messages",role:"region","aria-label":"System messages"};b.render=function(e,a,s,n,o,i){const r=t.resolveComponent("cdx-message");return i.normalizedMessages.length?(t.openBlock(),t.createElementBlock("div",C,[t.createElementVNode("div",S,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(i.normalizedMessages,a=>(t.openBlock(),t.createBlock(r,{key:a.id,type:a.type,dismissible:"",class:"lpm-message-item",onDismiss:t=>e.$emit("dismiss",a.id)},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(a.text),1)]),_:2},1032,["type","onDismiss"]))),128))])])):t.createCommentVNode("v-if",!0)},b.__scopeId="data-v-1ba2a834",b.__file="resources/src/ui/messages.vue";var $={name:"LpmDialogs",props:{importSummary:{type:Array,required:!0,default:()=>[]},upgradeSummary:{type:Array,required:!0,default:()=>[]},showImportConfirm:{type:Boolean,required:!0},showUpdateConfirm:{type:Boolean,required:!0},importTitle:{type:String,default:"Confirm Import"},updateTitle:{type:String,default:"Confirm Update"},importMessage:{type:String,default:"Import selected packs and pages?"},updateMessage:{type:String,default:"Update existing pages from the selected repository?"}},emits:["confirm-import","close-import","confirm-update","close-update","update:showImportConfirm","update:showUpdateConfirm"],data(){return{localImportOpen:this.showImportConfirm,localUpdateOpen:this.showUpdateConfirm}},computed:{safeImportSummary(){return(this.importSummary||[]).filter(e=>e&&"object"==typeof e&&"string"==typeof e.name)},safeUpgradeSummary(){return(this.upgradeSummary||[]).filter(e=>e&&"object"==typeof e&&"string"==typeof e.name)}},watch:{showImportConfirm(e){this.localImportOpen=e},showUpdateConfirm(e){this.localUpdateOpen=e},localImportOpen(e){this.$emit("update:showImportConfirm",e)},localUpdateOpen(e){this.$emit("update:showUpdateConfirm",e)}},methods:{confirmImport(){this.$emit("confirm-import"),this.$emit("update:showImportConfirm",!1)},closeImport(){this.$emit("close-import"),this.$emit("update:showImportConfirm",!1)},confirmUpdate(){this.$emit("confirm-update"),this.$emit("update:showUpdateConfirm",!1)},closeUpdate(){this.$emit("close-update"),this.$emit("update:showUpdateConfirm",!1)}}};const N={class:"lpm-dialogs"},R={key:0,class:"lpm-import-summary"},P={key:0},E={key:0},I={key:1},O={key:1},V={key:0,class:"lpm-import-summary"},M={key:0},L={key:0},T={key:1};$.render=function(e,a,s,n,o,i){const r=t.resolveComponent("cdx-button"),l=t.resolveComponent("cdx-dialog");return t.openBlock(),t.createElementBlock("div",N,[t.createCommentVNode(" Import confirmation dialog "),t.createVNode(l,{open:o.localImportOpen,"onUpdate:open":a[0]||(a[0]=e=>o.localImportOpen=e),title:s.importTitle},{footer:t.withCtx(()=>[t.createVNode(r,{appearance:"primary",onClick:i.confirmImport},{default:t.withCtx(()=>[...a[3]||(a[3]=[t.createTextVNode(" Confirm ",-1)])]),_:1},8,["onClick"]),t.createVNode(r,{appearance:"quiet",onClick:i.closeImport},{default:t.withCtx(()=>[...a[4]||(a[4]=[t.createTextVNode(" Cancel ",-1)])]),_:1},8,["onClick"])]),default:t.withCtx(()=>[t.createElementVNode("p",null,t.toDisplayString(s.importMessage),1),i.safeImportSummary.length?(t.openBlock(),t.createElementBlock("div",R,[t.createElementVNode("ul",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(i.safeImportSummary,e=>(t.openBlock(),t.createElementBlock("li",{key:e.name},[t.createElementVNode("strong",null,t.toDisplayString(e.name),1),e.pages&&Array.isArray(e.pages)&&e.pages.length?(t.openBlock(),t.createElementBlock("span",P,[t.createTextVNode(" — "+t.toDisplayString(e.pages.length)+" page",1),e.pages.length>1?(t.openBlock(),t.createElementBlock("span",E,"s")):t.createCommentVNode("v-if",!0)])):t.createCommentVNode("v-if",!0),e.version?(t.openBlock(),t.createElementBlock("span",I," (v"+t.toDisplayString(e.version)+") ",1)):t.createCommentVNode("v-if",!0)]))),128))])])):(t.openBlock(),t.createElementBlock("p",O,[...a[2]||(a[2]=[t.createElementVNode("em",null,"No packs selected.",-1)])]))]),_:1},8,["open","title"]),t.createCommentVNode(" Upgrade confirmation dialog "),t.createVNode(l,{open:o.localUpdateOpen,"onUpdate:open":a[1]||(a[1]=e=>o.localUpdateOpen=e),title:s.updateTitle},{footer:t.withCtx(()=>[t.createVNode(r,{appearance:"primary",onClick:i.confirmUpdate},{default:t.withCtx(()=>[...a[5]||(a[5]=[t.createTextVNode(" Confirm ",-1)])]),_:1},8,["onClick"]),t.createVNode(r,{appearance:"quiet",onClick:i.closeUpdate},{default:t.withCtx(()=>[...a[6]||(a[6]=[t.createTextVNode(" Cancel ",-1)])]),_:1},8,["onClick"])]),default:t.withCtx(()=>[t.createElementVNode("p",null,t.toDisplayString(s.updateMessage),1),i.safeUpgradeSummary.length?(t.openBlock(),t.createElementBlock("div",V,[t.createElementVNode("ul",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(i.safeUpgradeSummary,e=>(t.openBlock(),t.createElementBlock("li",{key:e.name},[t.createElementVNode("strong",null,t.toDisplayString(e.name),1),e.pages&&Array.isArray(e.pages)&&e.pages.length?(t.openBlock(),t.createElementBlock("span",M,[t.createTextVNode(" — "+t.toDisplayString(e.pages.length)+" page",1),e.pages.length>1?(t.openBlock(),t.createElementBlock("span",L,"s")):t.createCommentVNode("v-if",!0)])):t.createCommentVNode("v-if",!0),e.version?(t.openBlock(),t.createElementBlock("span",T," (v"+t.toDisplayString(e.installedVersion||"—")+" → v"+t.toDisplayString(e.version)+") ",1)):t.createCommentVNode("v-if",!0)]))),128))])])):t.createCommentVNode("v-if",!0)]),_:1},8,["open","title"])])},$.__scopeId="data-v-2619661a",$.__file="resources/src/ui/dialogs.vue";let B=!1;function U(e,t,a){for(const[s,n]of Object.entries(e)){if(!u(s,n))continue;if(t[m(s,n)]&&a(n))return!0}return!1}function j(e="#labki-pack-manager-root"){const t=o.createApp({template:'<lpm-root ref="root" />',data:()=>({data:null,activeRepo:null,repos:[],isLoadingRepo:!1,isRefreshing:!1,repoMenuItems:[],messages:[],nextMsgId:1,showImportConfirm:!1,showUpdateConfirm:!1,selectedPacks:{},selectedPages:{},prefixes:{},renames:{},importSummary:[],upgradeSummary:[],messages:[],nextMsgId:1}),computed:{hasActiveRepo(){return!!this.activeRepo},hasImportableSelection(){return U(this.data?.hierarchy?.nodes||{},this.selectedPacks,e=>"new"===e.installStatus)},hasUpgradeableSelection(){return U(this.data?.hierarchy?.nodes||{},this.selectedPacks,e=>"safe-upgrade"===e.installStatus)}},methods:{async loadRepos(e=!1){try{const e=await l();this.repos=e,this.repoMenuItems=e.map(e=>({label:e.name||e.url,value:e.url}))}catch(e){console.error("[LabkiPackManager] Failed to initialize repos:",e),this.pushMessage(d.ERROR,"Failed to load repositories.")}},async getOrFetchManifest(e){let t=e?.data;return t||(this.pushMessage(d.INFO,`Loading manifest for ${this.activeRepo}...`),t=await r(this.activeRepo,!1),e&&(e.data=t)),this.data=t&&(t.hierarchy||t.manifest)?t:{hierarchy:null},t},mergeInstalledData(e,t){const a=Object.create(null);for(const e of t)e?.name&&(a[e.name]={version:e.version,installedVersion:e.installedVersion||e.version,installStatus:e.installStatus,pages:Object.fromEntries((e.pages||[]).map(e=>[e.name,e.final_title||e.finalTitle]))});const s=this.data?.hierarchy?.nodes||{},n={...this.selectedPacks};for(const[e,t]of Object.entries(s)){if(!u(e,t))continue;const s=m(e,t),o=a[s];if(!o){Object.assign(t,{installStatus:"new",isLocked:!1,installedVersion:null});continue}const i=String(o.installedVersion||"0.0.0"),r=String(t.version||"0.0.0"),l=p(i,r),d=c(i)===c(r);t.installedVersion=i,t.isLocked=!0,t.installStatus=0===l?"already-installed":d&&l<0?"safe-upgrade":d&&l>0?"downgrade":"incompatible-update",n[s]=!0,t.pages=(t.pages||[]).map(e=>{const t="string"==typeof e?e:e.name;return{name:t,finalTitle:o.pages[t]||null}})}this.selectedPacks=n},async loadRepo(){if(!this.activeRepo)return;this.isLoadingRepo=!0;const e=this.repos.find(e=>e.url===this.activeRepo);try{const t=await this.getOrFetchManifest(e),a=await async function(e){const t=`${mw.util.wikiScript("api")}?${new URLSearchParams({action:"labkiQuery",format:"json",formatversion:"2",repo:e}).toString()}`;let a,s;try{a=await fetch(t,{credentials:"same-origin"})}catch(t){throw new Error(`Network error fetching installed packs for ${e}: ${t}`)}if(!a.ok)throw new Error(`HTTP ${a.status} fetching installed packs for ${e}`);try{s=await a.json()}catch(t){throw new Error(`Invalid JSON from installed packs for ${e}: ${t}`)}const n=s&&(s.labkiQuery||s);return Array.isArray(n?.packs)?n.packs:[]}(this.activeRepo);this.mergeInstalledData(t,a),this.data?.graph&&(await this.$nextTick(),await this.renderMermaidGraph(this.data.graph)),this.pushMessage(d.SUCCESS,mw.msg("labkipackmanager-load-success")||"Manifest loaded.")}catch(e){const t=`Failed to load ${this.activeRepo}: ${e?.message||e}`;this.pushMessage(d.ERROR,t.trim())}finally{this.isLoadingRepo=!1}},async refresh(){if(this.activeRepo){this.isRefreshing=!0,this.pushMessage(d.INFO,`Refreshing manifest for ${this.activeRepo}...`);try{const e=await r(this.activeRepo,!0);this.data=e&&(e.hierarchy||e.manifest)?e:{hierarchy:null};const t=this.repos.find(e=>e.url===this.activeRepo);t&&(t.data=e),this.data?.graph&&(await this.$nextTick(),await this.renderMermaidGraph(this.data.graph)),this.pushMessage(d.SUCCESS,mw.msg("labkipackmanager-refresh-success")||"Manifest refreshed.")}catch(e){const t=`Failed to refresh ${this.activeRepo}: ${e?.message||e}`;this.pushMessage(d.ERROR,t.trim())}finally{this.isRefreshing=!1}}else this.pushMessage(d.WARNING,"Select a repository first.")},async checkTitleExists(e){try{const t=new mw.Api,a=await t.get({action:"labkiPageExists",format:"json",formatversion:"2",title:e});return Boolean(a?.labkiPageExists?.exists)}catch(e){return console.warn("[LabkiPackManager] checkTitleExists failed:",e),!1}},async renderMermaidGraph(e){try{const t=function(e){if(!e)return"graph LR\n%% No graph data";const t=new Map,a=e=>(t.has(e)||t.set(e,`n${t.size+1}`),t.get(e)),s=["graph TB","%% Auto-generated by LabkiPackManager"],n=[...e.containsEdges||[]].map(e=>({...e,rel:"contains"})),o=[...e.dependsEdges||[]].map(e=>({...e,rel:"depends"})),i=[...n,...o],r=new Set,l=new Set;for(const t of e.roots||[])r.add(t);for(const{from:e,to:t}of n)r.add(e),l.add(t);for(const{from:e,to:t}of o)r.add(e),r.add(t);const c=new Set;for(const{from:e,to:t,rel:n}of i){const o=a(e),i=a(t),r="depends"===n?"-.->":"--\x3e";s.push(`${o} ${r} ${i}`),c.add(e),c.add(t)}for(const t of e.roots||[])c.add(t);for(const e of c){const t=a(e),n=e.replace(/^pack:/,"").replace(/^page:/,""),o=r.has(e)?`([${n}]):::pack`:`[${n}]:::page`;s.push(`${t}${o}`)}return s.push("classDef pack fill:#eef7ff,stroke:#4682b4,color:#1f2937;"),s.push("classDef page fill:#f8fafc,stroke:#94a3b8,color:#111827;"),s.join("\n")}(e),a=document.getElementById("lpm-graph");if(!a)return;if(await new Promise(e=>requestAnimationFrame(e)),a.innerHTML=`<div class="mermaid">${t}</div>`,!function(){if(B)return!0;try{const e=s&&(s.default?.initialize?s.default:s);if(e&&"function"==typeof e.initialize)return e.initialize({startOnLoad:!1,theme:"neutral",securityLevel:"loose",fontFamily:"Inter, system-ui, sans-serif"}),B=!0,!0}catch{}return!1}())return;const n=s&&(s.default?.run?s.default:s);n&&"function"==typeof n.run&&await n.run({nodes:[a.firstChild]})}catch(e){console.error("[LabkiPackManager] Mermaid render failed:",e)}},pushMessage(e,t,a=5e3){const s=this.nextMsgId++;this.messages.push({id:s,type:e,text:t}),a&&setTimeout(()=>this.dismissMessage(s),a)},dismissMessage(e){this.messages=this.messages.filter(t=>t.id!==e)},confirmImport(){const e=this.$refs.root,t=e?.$refs?.tree;if(t&&this.activeRepo){const e=t.exportSelectionSummary(this.activeRepo);this.importSummary=(e?.packs||[]).filter(e=>e.selected&&"new"===e.installStatus)}else this.importSummary=[];this.showImportConfirm=!0},confirmUpdate(){const e=this.$refs.root,t=e?.$refs?.tree;if(t&&this.activeRepo){const e=t.exportSelectionSummary(this.activeRepo);this.upgradeSummary=(e?.packs||[]).filter(e=>e.selected&&"safe-upgrade"===e.installStatus)}else this.upgradeSummary=[];this.showUpdateConfirm=!0},async doImport(){this.showImportConfirm=!1;const e=this.$refs.root,t=e?.$refs?.tree;if(!t||"function"!=typeof t.exportSelectionSummary)return void this.pushMessage(d.ERROR,"Tree component not ready. Try again.");const a=t.exportSelectionSummary(this.activeRepo),s=a.packs.filter(e=>e.selected&&"new"===e.installStatus);this.pushMessage(d.INFO,"Starting import…");try{const e=new mw.Api,t=await e.postWithToken("csrf",{action:"labkiUpdate",format:"json",formatversion:"2",actionType:"importPack",contentRepoUrl:a.repoUrl,packs:JSON.stringify(s)});if(t?.labkiUpdate?.success)this.pushMessage(d.SUCCESS,"Import completed.");else{const e=t?.labkiUpdate?.error||"Import failed.";this.pushMessage(d.ERROR,e)}}catch(e){console.error("[Import]",e),this.pushMessage(d.ERROR,e.message||"Import error.")}},doUpdate(){this.showUpdateConfirm=!1;const e=this.$refs.root,t=e?.$refs?.tree;if(!t||"function"!=typeof t.exportSelectionSummary)return void this.pushMessage(d.ERROR,"Tree component not ready. Try again.");const a=t.exportSelectionSummary(this.activeRepo);console.log("[Upgrade payload]",a),this.pushMessage(d.SUCCESS,"Upgrade triggered.")}},async mounted(){await this.loadRepos()}});for(const[e,a]of Object.entries(i))if(e?.startsWith("Cdx")&&a){const s=e.replace(/^Cdx/,"Cdx-").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();t.component(s,a)}t.component("lpm-root",{components:{LpmToolbar:h,LpmTree:y,LpmMessages:b,LpmDialogs:$},template:'\n      <div class="lpm-root">\n        <lpm-toolbar\n          :repo-menu-items="$root.repoMenuItems"\n          :active-repo="$root.activeRepo"\n          :is-loading-repo="$root.isLoadingRepo"\n          :is-refreshing="$root.isRefreshing"\n          :has-active-repo="$root.hasActiveRepo"\n          @update:activeRepo="val => $root.activeRepo = val"\n          @load="$root.loadRepo"\n          @refresh="$root.refresh"\n        />\n        <div class="lpm-row lpm-row-graph"><div id="lpm-graph" class="lpm-graph"></div></div>\n        <lpm-tree\n          ref="tree"\n          :data="$root.data"\n          :selected-packs="$root.selectedPacks"\n          :prefixes="$root.prefixes"\n          :renames="$root.renames"\n          :check-title-exists="$root.checkTitleExists"\n          @update:selectedPacks="val => $root.selectedPacks = val"\n          @update:prefixes="val => $root.prefixes = val"\n          @update:renames="val => $root.renames = val"\n        />\n        <div class="lpm-row lpm-row-actionbar">\n          <div class="lpm-actionbar">\n            <cdx-button :disabled="!$root.hasImportableSelection" @click="$root.confirmImport">Import Selected</cdx-button>\n            <cdx-button :disabled="!$root.hasUpgradeableSelection" @click="$root.confirmUpdate">Upgrade Existing</cdx-button>\n            <span class="lpm-action-info" style="margin-left: 1em;">\n              {{ $root.activeRepo ? (\'Active repo: \' + $root.activeRepo) : \'No repository selected.\' }}\n            </span>\n          </div>\n        </div>\n        <lpm-messages :messages="$root.messages" @dismiss="$root.dismissMessage" />\n        <lpm-dialogs\n          :import-summary="$root.importSummary"\n          :upgrade-summary="$root.upgradeSummary"\n          :show-import-confirm="$root.showImportConfirm"\n          :show-update-confirm="$root.showUpdateConfirm"\n          @confirm-import="$root.doImport"\n          @close-import="() => $root.showImportConfirm = false"\n          @confirm-update="$root.doUpdate"\n          @close-update="() => $root.showUpdateConfirm = false"\n        />\n      </div>\n    '});document.querySelector(e)?t.mount(e):console.error(`[LabkiPackManager] Root element not found: ${e}`)}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>j()):j(),e.mountApp=j,e}({},Vue,Codex,mermaid);
//# sourceMappingURL=app.bundle.js.map
