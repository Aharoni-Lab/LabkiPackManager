name: tests

on: [push, pull_request]

jobs:
  phpunit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mw_branch: [REL1_44, REL1_43]
        php: ['8.2']
    steps:
      - uses: actions/checkout@v4
        with:
          path: extension

      - name: Get MediaWiki core
        run: |
          git clone https://gerrit.wikimedia.org/r/mediawiki/core.git mediawiki
          cd mediawiki
          git checkout ${{ matrix.mw_branch }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, intl, xml, json, sqlite3
          tools: composer

      - name: Install MW deps
        working-directory: mediawiki
        run: composer update --no-interaction

      - name: Install MW with SQLite
        working-directory: mediawiki
        run: |
          mkdir -p cache/sqlite
          php maintenance/install.php \
            --dbtype sqlite --dbpath $(pwd)/cache/sqlite \
            --server "http://example.local" --scriptpath "/w" \
            --lang en --pass pass Wiki Admin

      - name: Enable extension
        run: |
          echo "wfLoadExtension( 'LabkiPackManager' );" >> mediawiki/LocalSettings.php
          ln -s "$GITHUB_WORKSPACE/extension" mediawiki/extensions/LabkiPackManager

      - name: PHPUnit unit
        working-directory: mediawiki
        run: |
          if [ -d "extensions/LabkiPackManager/tests/phpunit/unit" ]; then
            composer phpunit:unit -- extensions/LabkiPackManager/tests/phpunit/unit
          else
            echo "No unit tests directory found; skipping."
          fi

      - name: PHPUnit integration
        working-directory: mediawiki
        env:
          PHPUNIT_WIKI: wiki
        run: |
          if [ -d "extensions/LabkiPackManager/tests/phpunit/integration" ]; then
            composer phpunit:entrypoint -- extensions/LabkiPackManager/tests/phpunit/integration
          else
            echo "No integration tests directory found; skipping."
          fi


